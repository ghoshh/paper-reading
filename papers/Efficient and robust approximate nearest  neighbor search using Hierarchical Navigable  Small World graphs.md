# 结构
HNSW是个多层图，每个向量会被随机分配到若干层（Level 0 ~ L），层数的分布遵循指数衰减规律（高层节点少，底层节点多）。可以理解成高层的是长距离的边，低层的是短距离的边。
构建流程简而言之就是依次插入节点，插入新节点时，在它所在的每层中都是和当前图中有的节点且离它最近的一些节点连边。
# 插入节点
# 流程
每次插入一个新的向量v时每次插入一个新的向量v时随机分配它的层高L_v。
第一个阶段zoom-in: 从入口点出发，从最高层到L_v + 1层依次枚举，找到离v最近的节点作为下一层的入口点。
接下来从L_v层开始依次往下走，在当前层搜索ef_construction个最近邻，并选择前M近的邻居连双向边，如果邻居的度数满了就剪枝，
## search-layer
从当前层layer的起点entry_point出发，找到距离查询向量query最近的ef个向量。
用best-first的方式搜，有个候选集，每次拿出来当前距离query最近的点并遍历它的所有的邻居，放到候选集里，一直循环，一直到结果集的数量够ef个。
## 启发式剪枝
先将所有候选邻居按到节点e的距离从小到大排序，依次检查候选点，只有当一个候选点到e的距离比到e的所有已有的邻居的距离都短时，才加这个点。这样可以保证邻居的空间方向的多样化，优先保留位于不同方向的点。
比如这个图，绿色的是新加的点，选择启发式剪枝可以把位于不同cluster的e2加进来，要不如果只加离它最近的几个点，加的点可能都是cluster1的点。
这样可以保留一些长边，而且还保证了图的连通性。
![[Pasted image 20260121002303.png]]
# 搜索
从顶层到倒数第二层，找离query最近的1个点，在最后一层，找离query最近的k个点