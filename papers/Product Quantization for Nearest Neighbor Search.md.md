https://ieeexplore.ieee.org/document/5432202
# PQ
给定 N 个 d 维向量，每 m 维划分为一个子空间（d % m = 0）。
对于每个子空间，使用 KMeans 训练得到 k 个聚类中心，
这 k 个聚类中心构成该子空间的码本。

对于每个向量，其在每个子空间上的子向量
由该子空间中距离最近的聚类中心的 id 表示。
最终，每个向量从一个 d 维的 float 类型向量
被表示为一个 nlist = d / m 维的 int 类型向量，也就是每个子空间应该训练${2}^{nlist}$ 个聚类
为了让每个子空间的码本的nlist位的每一位都有意义，nlist最好是8,16,32这种，对应uint8,uint16,uint64等

# IVF-FLAT
## 构建索引
使用K-Means算法将数据库中的所有向量聚类成nlist个聚类，为每个聚类建立一个链表，存属于该聚类的向量（原始向量）。
## 查询
找到离查询向量q最近的nprobe个聚类中心，枚举这nprobe个聚类中所有的距离找到离q最近的k个向量。
# IVF-PQ
## 构建索引
先整体聚类一下分出来一些桶，算出来所有向量的residual，也就是每个向量减去对应聚类中心的向量，拿到所有的residual，用PQ量化residual
## 查询（IVFADC）
ADC是指查询向量q与压缩向量p算距离的时候，不把q进行量化，而是预先算出来每个子空间中，q的部分与对应子空间所有聚类中心的距离的平方。这样的话算q与p的距离直接就去查表，拿到每个子空间的p对应的id的距离再累加起来就好了。

SDC是指把查询向量q也量化一下，算两个压缩向量的距离，这样没有ADC精确。

找到离查询向量q最近的nprobe个聚类中心，枚举这nprobe个聚类中心ci，算一下r(qi)=q-ci,然后再去和算一下r(qi)和码本所有点的距离，和IVF-PQ的查询的步骤就一样了

# 参数调优
## nlist
索引构建时的聚类数量，越大，聚类中心数越多，每个桶里的向量数越少。
如果太小，粗量化快，但是桶里的向量个数太多。
如果太大，粗量化就会慢。不过划分的会更细致，需要nprobe配合调整，不然recall会下降
建议$\sqrt{n}$ 量级
## nprobe
搜索多少个桶
与latency线性增长，与recall对数增长。